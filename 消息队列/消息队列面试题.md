# 消息队列面试题

## Kafka如何保证消息的消费顺序？

Kafka只能为我们保证分区中的消息有序。

1. 1个Topic只对应一个Partition。

2. 发送需要保证顺序的消息时，指定partition。

## Kafka如何保证消息不丢失？

**生产者丢失消息**

生产者调用`send`方法发送消息之后，可能因为网络问题没有发送过去。

可以通过Future类添加回调函数，来确认发送是否成功。

Producer的`retries`可以设置一个合理的数值，比如3。

**消费者丢失消息**

消息在被追加到Partition时会被分配一个特定的偏移量。偏移量表示Consumer当前消费到的Partition所在的位置，Kafka通过偏移量可以保证消息在分区内的顺序性。

当消费者拉取到了分区的某个消息后，消费者自动提交了offset。

**Kafka弄丢了消息**

加入leader副本所在的broker挂掉，要从follower副本重新选出一个leader，但是leader的数据还有一些没有被follower副本同步。

设置acks=all。

acks的默认值为1，代表我们的消息被leader副本接受之后结算被成功发送。

acks=all表示只有所有ISR列表的副本全部收到消息时，生产者才会接收到来自服务器的响应。

## Kafka如何保证消息不重复消费？

+ 服务端测已经消费的数据没有成功提交offset。

+ Kafka侧由于服务端处理业务时间长或网路连接等等原因让Kafka认为服务器假死。

解决方案：

+ 消费消息服务做幂等校验。

+ 将`enable.auto.commit`参数设置为false。
  
  1. 处理完消息再提交，有重复消费的风险。
  
  2. 拉取到消息再提交，会有消息丢失的风险。


