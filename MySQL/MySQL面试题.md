# MySQL面试题

## MySQL日志

### 常见的日志有哪些？

+ 错误日志
  
  **错误日志**文件记录了所有的错误信息，也记录一些警告信息或正确的信息。可以通过`SHOW VARIABLES LIKE ’log_error‘`来定位文件。

+ 二进制日志
  
  **二进制日志**记录了对MySQL数据库进行更改的所有操作，不包括`SELECT`和`SHOW`等只进行展示的操作。

+ 慢查询日志
  
  帮助定位可能存在问题的sql语句，从而进行sql语句层面的优化。在MySQL启动时设置一个阈值，运行时间超过该值的所有SQL语句都记录到慢查询日志中。该阈值可以通过参数**long_query_time**设置，默认为10s。
  
  可以通过`SHOW VARIABLES LIKE 'long_query_time'`定位文件。
  
  **long_queries_not_using_indexes**可以记录没有使用索引的sql语句。

+ 查询日志
  
  **查询日志**记录了所有对MySQL数据库请求的信息，无论这些请求是否得到了正确的执行。默认文件名为：**主机.log**。

### 二进制日志

**二进制日志的数据格式**

二进制日志文件的格式为二进制，必须通过MySQL提供的工具mysqlbinlog才能查看。

**二进制日志**的作用：

+ 恢复，可以通过二进制日志进行数据恢复。

+ 复制。通过复制和执行二进制文件使一台远程的MySQL数据库进行实时同步。

+ 审计，判断是否有对数据库进行注入的攻击。

在事务提交过程中，未提交事务的二进制日志会被记录到缓存中，在事务提交之后写入二进制日志文件。

## MySQL事务

### MySQL中redo log是什么？

**redo log**称作重做日志，可以在MySQL实例宕机时恢复数据，保证数据的持久性。

redo log由两部分组成：内存中的redo log缓冲和redo log文件。

在innoDB中，默认情况下事务提交时首先把日志写入内存缓冲区，再调用fsync将数据持久化到磁盘中，待事务的COMMIT操作完成才算事务最终完成。

**redolog与binlog的区别**

+ **redo log**是在InnoDB存储引擎层实现的，**binlog**是在MySQL数据库上层实现的，**binlog**可以针对任何存储引擎。

+ **binlog**是一种逻辑日志，记录的是sql语句。**redolog**是物理格式日志，记录的是每个页的修改。

+ **binlog**在事务提交后一次写入，**redolog**在事务进行中不断写入。

+ **binlog**一般用于主从复制，**redolog**一般用于宕机恢复。

### 为什么宕机恢复用redolog不用binlog？

innoDB存储引擎的redolog是物理日志，其恢复速度比binlog快得多。

### MySQL中undo log是什么？

事务有时需要进行回滚操作，需要利用**undolog**的信息将数据回滚到修改之前的样子。

**undolog**记录的是与之前相反的操作。对于每一个`INSERT`，**undolog**会记录一个`DELETE`；对于每一个`DELETE`，**undolog**会记录一个`INSERT`；对于每个`UPDATE`，**undolog**会记录一个相反的`UPDATE`。

除了回滚操作，**undolog**的另一个作用是MVCC。当前事务读取一行记录时如果该记录已经被其他事务占用，当前事务可以通过**undolog**读取事务开启时的行记录信息，从而实现非锁定读取。

### 事务的隔离级别

+ 读未提交，允许读取尚未提交的数据变更。

+ 读已提交，允许读取并发事务已经提交的数据。读取被锁定行最新一份快照数据。

+ 可重复读，对同一字段多次读取结果是一致的。读取事务开始时的行数据版本。

+ 串行化

## MySQL锁

### MySQL中锁的类型有哪些？

+ 共享锁，允许事务读一行数据。

+ 排他锁，允许事务删除或更新一行数据。

排他锁与其他任何锁互斥；共享锁与排他锁互斥与共享锁不互斥。

**意向锁**。意向锁为表级别的锁，但不产生实际作用。如果后一个任务试图在表级别上应用共享锁或排他锁，在锁定表之前不必检查各个行锁，只需检查表上的意向锁。

### 锁有可能带来哪些问题？

1. **脏读**
   
   脏数据指缓冲池中尚未被提交的修改。**脏读**是指在不同事务下，当前事务可以读到其他事务未提交的数据。

2. **不可重复读**
   
   **不可重复读**是指在一个事务内多次读取同一数据集合。在当前事务还没有结束时，另一个事务也访问了同一个数据集合并执行一些DML操作。在当前事务两次读取数据之间，由于第二个事务的修改导致当前事务两次读取的数据不一致。

3. **丢失更新**
   
   一个事务的更新操作被另一个事务的更新操作覆盖，从而导致一个事务的更新丢失。

## MySQL索引

### 索引的底层结构

B+树是一种多路平衡查找树。

+ 每一个节点有若干个子节点。

+ 每一层的节点从左往右从小到大排列。

+ 包含查询数据的所有节点位于树的最底层同一层，且叶子节点之间通过指针连接。

### 联合索引是什么？对a、b、c三个字段用联合索引，where a=xxx and b=xxx时，索引能起作用么？where b=xxx and a=xxx时索引能起作用么？

**联合索引**是指对表上的多个列进行索引，创建方法与单个索引相同。

**联合索引**也是一颗B+树，只是键值的数量大于等于2，比如对于a、b、c三个字段的**联合索引**的B+树中节点的值为(a=1,b=2,c=3)。

对于a=xxx and b=xxx是可以起效的，因为键值中先按a排序再按b排序，可以查询到有序的数据。而对于b=xxx无法查询到有序的数据，因此不能起作用。

### 聚集索引、辅助索引、覆盖索引分别是什么？

**聚集索引**按每张表的主键构造B+树，叶子节点中存放整张表的行记录数据。

**辅助索引**的叶子节点不包含行记录的全部数据，叶子节点中包含了相应行数据的聚集索引键。

**覆盖索引**即从辅助索引中就可以得到查询的记录。

### 索引调优的经验

**如何发现需要优化的索引？**

**慢查询日志**中可以再MySQL启动时设置一个阈值，将运行时间超过该值的所有sql语句记录到慢查询日志中。

MYSQL5.1开始将慢查询日志放在一张名为slow_log的表中，包括query_time查询时间和sql_text语句文本。

`EXPLAIN`命令中包括了sql语句可以使用的索引和最终执行时使用的索引。

**哪些问题导致索引失效？**

+ 联合索引没有遵循最左匹配原则。

+ 在索引列上进行计算、函数等操作。

+ 以%开头的LIKE操作。

+ 查询条件中用OR，且OR的前后条件中有一个列没有索引。

### 倒排索引是什么？

全文检索通常使用**倒排索引**来实现，它在辅助表中存储了单词与单词自身在一个或多个文档中所在位置之间的映射，拥有两种表现形式。

+ inverted file index，表现形式为{单词，单词所在文档的ID}

+ full invertedIndex，表现形式为{单词，{单词所在文档ID，在具体文档中的位置}}

### 如何进行全文检索？

如`select * from table where body Like '%Pease%'`改写为

`select * from table where match(body) AGAINST ('Pease')`

MySQL数据库通过`MATCH()……AGAINST()`语法支持全文检索的查询，`MATCH`指定了需要被查询的列，`AGAINST`指定了使用何种方式进行查询。    

## 数据库范式

**第一范式**

属性不能再被分割，只能是一个值，不能再被分为多个字段。**1NF是关系型数据库的基本要求**。

**第二范式**

**2NF**在1NF的基础上消除了非主属性对于码的部分函数依赖。

第二范式在第一范式的基础上增加了一列，称为主键。

**第三范式**

**3NF**在2NF的基础上消除了非主属性对于码的传递函数依赖。

**传递函数依赖**：如果X确定Y、Y确定Z，则称Z传递依赖于X。
