# 分布式、微服务

## 理论&算法&协议

### CAP理论

CAP是Consistency（一致性）、Availability（可用性）、Partition    Tolerance（分区容错性）的组合。

+ 一致性：所有节点访问同一份最新的数据副本。

+ 可用性：非故障节点在合理时间内返回合理响应。

+ 分区容错性：分布式系统出现网络分区时，仍能够对外提供服务。

**什么是网络分区？**

分布式系统中，多个节点之间的网络本来是联通的，但是因为某些故障，节点间不连通了，整个网络分成了几块区域，就叫网络分区。

P是一定要满足的，在此基础上只能满足A或C。

如果网络分区正常的话，C和A可以同时保证。

### BASE理论

BASE是Basically Available（基本可用）、Soft-state（软状态）和Eventually Consistent（最终一致性）的缩写。

BASE理论是对CAP中一致性C和可用性A权衡的结果。

**BASE理论的核心思想**

即使无法做到强一致性，但每个应用可以根据自身业务特定，采用适当方式来使系统达到最终一致性。

**基本可用**是指分布式系统在出现不可预知故障时，允许损失部分可用性。部分可用性是指**响应时间上的损失**，**系统功能上的损失**。

**软状态**指允许系统中的数据存在中间状态，并认为中间状态的存在不会影响系统的整体可用性。

**最终一致性**强调系统中所有数据副本，经过一段时间的同步后，最终能够达到一致的状态。

### Paxos算法

**Basic Paxos**中存在3个重要角色：

1. 提议者：负责接受客户端的请求并发起提案。提案信息通常包括提案编号和提议的值。

2. 接受者：负责对提议者的提案进行投票，同时需要记住自己的投票历史。

3. 学习者：如果有超过半数接收者就某个提议达成了共识，那么学习者就需要接受这个提议，并就该提议作出运算，然后将运算结果返回给客户端。

### Raft算法

一个Raft集群包括若干服务器，每个服务器一定会处于以下三个状态中的一个：

+ `Leader`：负责发起心跳，响应客户端，创建日志，同步日志。

+ `Candidate`：Leader选举过程中的临时角色，由Follower转化而来，发起投票参与竞选。

+ `Follower`：接受Leader的心跳和日志同步数据，投票给Candidate。
  
  正常情况下，只有一个服务器是Leader，剩下的服务器都是Follower。

**任期**

raft算法将时间划分为任意长度的任期，任期用连续的数字表示。每一个任期的开始都是一次选举，在选举开始时，一个或多个Candidate会尝试成为Leader。如果一个Candidate赢得了选举，它就会在该任期内担任Leader。

**日志**

每一个事件成为`entry`，只有Leader可以创建entry。

`log`是由`entry`构成的数组。

entry总是先被Leader添加到自己的log数组中，然后再发起共识请求，获得同意后才会被Leader提交给状态机。

**领导人选举**

raft使用心跳机制来触发Leader选举。

**Leader**会向所有Follower周期性发送心跳来保证自己的Leader地位。如果一个Follower在一个周期内没有收到心跳信息，就叫做选举超时，它就会认为此时没有可用的Leader，并且开始进行一次选举。

**日志复制**

Leader收到客户端请求后，会生成一个entry，再将这个entry添加到自己的日志末尾，向所有节点广播该entry，要求其他服务器复制这条entry。

如果Leader收到了多数的成功响应，Leader会将这个entry应用到自己的状态机中。

## Gossip协议

Gossip设计了两种可能的消息传播模式：反熵和传谣。

+ **反熵**：集群中的节点，每隔段时间就随机选择某个其他节点，然后通过互相交换自己的所有数据来消除两者之间的差异。在实际应用场景中，一般不会采用随机的节点进行反熵，而是可以设计成一个闭环。

+ **谣言传播**：谣言传播是指分布式系统中的一个节点一旦有了新的数据之后，就变成了活跃节点。活跃节点会周期性地联系其他节点发送新数据，直到所有节点都存储了该新数据。

## 远程调用

OpenFeign

## 服务注册与发现



## API网关

网关主要做了两件事情：**请求转发**+**请求过滤**。

网关服务通过Nginx进行负载转发以达到高可用。

### Spring Cloud Gateway断言是什么？

在Gateway中，如果客户端发送的请求满足了断言的条件，则映射到指定的路由器，就能转发到指定的服务上处理。

### Spring Cloud Gateway如何实现动态路由？

实现动态路由的方式有很多，一种推荐的方式是基于Nacos注册中心，Spring Cloud Gateway可以从注册中心获取服务的元数据。

### Spring Cloud Gateway的过滤器有哪些？

+ **Pre类型**：在请求被转发到微服务之前，对请求进行拦截和修改。

+ **Post类型**：微服务处理完请求后，返回响应给网关。

+ **GatewayFilter**：局部过滤器，应用在单个或一组路由上的过滤器。

+ **GlobalFilter**：全局过滤器，应用在所有路由上的过滤器。

### Spring Cloud Gateway支持限流吗？

Spring Cloud Gateway自带限流过滤器，对应的接口是`RateLimiter`，只有一个实现类`RedisRateLimiter`。

### Spring Cloud Gateway全局异常处理

在SpringBoot项目中，捕获全局异常只需要在项目中配置`@RestControllerAdvice`和`@ExceptionHandler`就可以了。

## 配置中心



## 分布式ID

分布式ID就是分布式系统下的ID。

在分布式数据库，数据遍布在不同服务器上的数据库，如何为不同的数据节点生成全局唯一主键呢？

分布式ID需要满足以下要求：

+ 全局唯一。

+ 高性能。

+ 高可用。

+ 方便易用。

### 分布式ID场景解决方案

1. 通过关系型数据库的自增主键来产生唯一的ID。

2. 通过关系型数据库批量获取，然后存在内存里面，需要用的时候直接从内存里面拿。

3. 通过Redis的incr实现对id的原子性递增。

4. UUID，生成速度快但存储消耗空间大、无序。

5. Snowflake，组成为sign（符号位）+timestamp（时间戳）+datacenterid（机房、机器ID）+sequence（代表单台机器每毫秒产生的最大ID数）缺点：需要解决重复ID问题。

## 分布式事务



## 分布式链路追踪（先不学）


